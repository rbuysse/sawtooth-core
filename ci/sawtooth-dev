# Copyright 2018-2020 Cargill Incorporated
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

FROM ubuntu:bionic

RUN apt-get update \
 && apt-get install gnupg -y

RUN echo "deb http://repo.sawtooth.me/ubuntu/nightly bionic universe" >> /etc/apt/sources.list \
 && (apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 44FC67F19B2466EA \
 || apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 44FC67F19B2466EA)

# Install base dependencies
RUN apt-get update \
 && apt-get install -y -q \
    build-essential \
    curl \
    g++ \
    gcc \
    git \
    libpq-dev \
    libsasl2-dev \
    libssl-dev \
    libzmq3-dev \
    openssl \
    pandoc \
    pkg-config \
    python \
    python3 \
    python3-aiodns \
    python3-aiohttp \
    python3-cachetools \
    python3-cchardet\
    python3-dev \
    python3-grpcio \
    python3-grpcio-tools \
    python3-protobuf \
    python3-pyformance \
    python3-sawtooth-sdk \
    python3-secp256k1 \
    python3-stdeb \
    python3-toml \
    unzip \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

ENV PATH=$PATH:/root/.cargo/bin

# Install Rust
RUN curl https://sh.rustup.rs -sSf > /usr/bin/rustup-init \
 && chmod +x /usr/bin/rustup-init \
 && rustup-init -y

# Install cargo deb
RUN cargo install cargo-deb

# Install protoc
RUN curl -OLsS https://github.com/google/protobuf/releases/download/v3.7.1/protoc-3.7.1-linux-x86_64.zip \
    && unzip -o protoc-3.7.1-linux-x86_64.zip -d /usr/local \
    && rm protoc-3.7.1-linux-x86_64.zip

ENV PATH=$PATH:/project/sawtooth-core/bin:/root/.cargo/bin \
    CARGO_INCREMENTAL=0

# Create empty cargo projects for top-level projects
WORKDIR /build
RUN USER=root cargo new --bin validator
RUN USER=root cargo new --bin adm

# Create empty Cargo projects for perf tools
RUN USER=root cargo new --bin perf/sawtooth_perf
RUN USER=root cargo new --bin perf/smallbank_workload
RUN USER=root cargo new --bin perf/intkey_workload
RUN USER=root cargo new --bin perf/sawtooth_workload

# Create empty Cargo projects for STUFF FIX THIS COMMENTTTTTTTTTTTTTTTTTTTTTTTTTTT
RUN USER=root cargo new --bin families/settings/sawtooth_settings
RUN USER=root cargo new --bin families/identity/sawtooth_identity
RUN USER=root cargo new --bin families/battleship
RUN USER=root cargo new --bin families/block_info/sawtooth_block_info
RUN USER=root cargo new --bin families/smallbank/smallbank_rust

# Copy over STUFF FIX THIS COMMENTTTTTTTTTTTTTTTTTTTTTTTTTTT

COPY adm/build.rs /build/adm/build.rs
COPY adm/Cargo.toml /build/adm/Cargo.toml

COPY families/battleship/Cargo.toml /build/families/battleship/Cargo.toml
COPY families/battleship/examples /build/families/battleship/examples

COPY families/block_info/protos /build/families/block_info/protos
COPY families/block_info/sawtooth_block_info/build.rs /build/families/block_info/sawtooth_block_info/build.rs
COPY families/block_info/sawtooth_block_info/Cargo.toml /build/families/block_info/sawtooth_block_info/Cargo.toml

COPY families/identity/protos /build/families/identity/protos
COPY families/identity/sawtooth_identity/build.rs /build/families/identity/sawtooth_identity/build.rs
COPY families/identity/sawtooth_identity/Cargo.toml /build/families/identity/sawtooth_identity/Cargo.toml

COPY families/settings/protos /build/families/settings/protos
COPY families/settings/sawtooth_settings/build.rs /build/families/settings/sawtooth_settings/build.rs
COPY families/settings/sawtooth_settings/Cargo.toml /build/families/settings/sawtooth_settings/Cargo.toml

COPY families/smallbank/protos /build/families/smallbank/protos
COPY families/smallbank/smallbank_rust/build.rs /build/families/smallbank/smallbank_rust/build.rs
COPY families/smallbank/smallbank_rust/Cargo.toml /build/families/smallbank/smallbank_rust/Cargo.toml

COPY perf/intkey_workload/Cargo.toml /build/perf/intkey_workload/Cargo.toml

COPY perf/sawtooth_perf/Cargo.toml /build/perf/sawtooth_perf/Cargo.toml

COPY perf/sawtooth_workload/Cargo.toml /build/perf/sawtooth_workload/Cargo.toml

COPY perf/smallbank_workload/build.rs /build/perf/smallbank_workload/build.rs
COPY perf/smallbank_workload/Cargo.toml /build/perf/smallbank_workload/Cargo.toml

COPY protos /build/protos

COPY validator/build.rs /build/validator/build.rs
COPY validator/Cargo.toml /build/validator/Cargo.toml

# This is required for validator because it has a library and a binary
RUN cp /build/validator/src/main.rs /build/validator/src/lib.rs

# Battleship is non-standard. It contains multiple "bin"s and an example file
RUN mkdir /build/families/battleship/src/bin
RUN cp /build/families/battleship/src/main.rs /build/families/battleship/src/bin/cli.rs
RUN cp /build/families/battleship/src/main.rs /build/families/battleship/src/bin/processor.rs
RUN cp /build/families/battleship/src/main.rs /build/families/battleship/examples.play.rs

# Do release builds for each Cargo.toml
RUN find . -name 'Cargo.toml' -exec \
    sh -c 'x="{}"; cargo build --release --manifest-path "$x" ' \;

# Clean up built files
RUN rm -rf \
    /build/adm/target/release/build/sawtooth-sawadm-* \
    /build/adm/target/release/deps/sawadm* \
    /build/adm/target/release/sawadm* \
    /build/families/battleship/target/release/*battleship* \
    /build/families/battleship/target/release/deps/*battleship* \
    /build/families/block_info/sawtooth_block_info/target/release/block-info-tp* \
    /build/families/block_info/sawtooth_block_info/target/release/build/sawtooth-block-info-tp* \
    /build/families/block_info/sawtooth_block_info/target/release/deps/block_info_tp* \
    /build/families/identity/sawtooth_identity/target/release/build/sawtooth-identity-tp* \
    /build/families/identity/sawtooth_identity/target/release/deps/identity_tp-* \
    /build/families/identity/sawtooth_identity/target/release/identity-tp* \
    /build/families/settings/sawtooth_settings/target/release/build/sawtooth-settings-tp* \
    /build/families/settings/sawtooth_settings/target/release/deps/settings_tp* \
    /build/families/settings/sawtooth_settings/target/release/settings-tp* \
    /build/families/smallbank/smallbank_rust/target/release/build/sawtooth-smallbank-tp-rust* \
    /build/families/smallbank/smallbank_rust/target/release/deps/smallbank_tp_rust* \
    /build/families/smallbank/smallbank_rust/target/release/smallbank-tp-rust* \
    /build/libsawtooth/target/release/deps/sawtooth* \
    /build/libsawtooth/target/release/sawtooth* \
    /build/perf/intkey_workload/target/release/deps/intkey_workload* \
    /build/perf/intkey_workload/target/release/intkey-workload* \
    /build/perf/sawtooth_perf/target/release/deps/sawtooth_perf* \
    /build/perf/sawtooth_perf/target/release/sawtooth_perf* \
    /build/perf/sawtooth_workload/target/release/deps/sawtooth_workload* \
    /build/perf/sawtooth_workload/target/release/sawtooth_workload* \
    /build/perf/smallbank_workload/target/release/build/sawtooth-smallbank-workload* \
    /build/perf/smallbank_workload/target/release/deps/smallbank_workload* \
    /build/perf/smallbank_workload/target/release/smallbank-workload* \
    /build/validator/target/release/*validator* \
    /build/validator/target/release/build/sawtooth_validator* \
    /build/validator/target/release/deps/*validator*

# Clean up leftover files
RUN find . -name 'Cargo.toml' -exec \
    sh -c 'x="{}"; rm "$x" ' \;

RUN find . -name 'main.rs' -exec \
    sh -c 'x="{}"; rm "$x" ' \;

RUN find . -name 'lib.rs' -exec \
    sh -c 'x="{}"; rm "$x" ' \;

RUN rm \
    /build/adm/build.rs \
    /build/families/battleship/examples/* \
    /build/families/battleship/src/bin/cli.rs \
    /build/families/battleship/src/bin/processor.rs \
    /build/families/block_info/sawtooth_block_info/build.rs \
    /build/families/identity/sawtooth_identity/build.rs \
    /build/families/settings/sawtooth_settings/build.rs \
    /build/families/smallbank/smallbank_rust/build.rs \
    /build/perf/smallbank_workload/build.rs \
    /build/validator/build.rs

RUN rm \
    /build/families/block_info/protos/* \
    /build/families/identity/protos/* \
    /build/families/settings/protos/* \
    /build/families/smallbank/protos/* \
    /build/protos/*

# Log the commit hash
COPY .git/ /tmp/.git/
WORKDIR /tmp
RUN git rev-parse HEAD > /commit-hash
WORKDIR /build
